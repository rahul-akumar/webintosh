<template>
  <div class="textedit-app">
    <!-- Formatting Toolbar -->
    <div v-if="showToolbar" class="toolbar">
      <!-- Text Formatting -->
      <div class="toolbar-group">
        <button 
          @click="handleBold" 
          :class="{ active: isFormatActive('bold') }"
          title="Bold (Cmd+B)"
        >
          <strong>B</strong>
        </button>
        <button 
          @click="handleItalic" 
          :class="{ active: isFormatActive('italic') }"
          title="Italic (Cmd+I)"
        >
          <em>I</em>
        </button>
        <button 
          @click="handleUnderline" 
          :class="{ active: isFormatActive('underline') }"
          title="Underline (Cmd+U)"
        >
          <u>U</u>
        </button>
        <button 
          @click="handleStrikethrough" 
          :class="{ active: isFormatActive('strikeThrough') }"
          title="Strikethrough"
        >
          <s>S</s>
        </button>
      </div>

      <div class="toolbar-divider"></div>

      <!-- Text Alignment -->
      <div class="toolbar-group">
        <button 
          @click="handleAlignLeft" 
          :class="{ active: isFormatActive('justifyLeft') }"
          title="Align Left"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M2 3h12v1H2zM2 6h8v1H2zM2 9h12v1H2zM2 12h8v1H2z"/>
          </svg>
        </button>
        <button 
          @click="handleAlignCenter" 
          :class="{ active: isFormatActive('justifyCenter') }"
          title="Align Center"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M4 3h8v1H4zM2 6h12v1H2zM4 9h8v1H4zM2 12h12v1H2z"/>
          </svg>
        </button>
        <button 
          @click="handleAlignRight" 
          :class="{ active: isFormatActive('justifyRight') }"
          title="Align Right"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M2 3h12v1H2zM6 6h8v1H6zM2 9h12v1H2zM6 12h8v1H6z"/>
          </svg>
        </button>
        <button 
          @click="handleJustify" 
          :class="{ active: isFormatActive('justifyFull') }"
          title="Justify"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M2 3h12v1H2zM2 6h12v1H2zM2 9h12v1H2zM2 12h12v1H2z"/>
          </svg>
        </button>
      </div>

      <div class="toolbar-divider"></div>

      <!-- Lists -->
      <div class="toolbar-group">
        <button 
          @click="handleBulletList" 
          :class="{ active: isFormatActive('insertUnorderedList') }"
          title="Bullet List"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <circle cx="3" cy="4" r="1"/>
            <circle cx="3" cy="8" r="1"/>
            <circle cx="3" cy="12" r="1"/>
            <path d="M6 3.5h8v1H6zM6 7.5h8v1H6zM6 11.5h8v1H6z"/>
          </svg>
        </button>
        <button 
          @click="handleNumberedList" 
          :class="{ active: isFormatActive('insertOrderedList') }"
          title="Numbered List"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <text x="2" y="5" font-size="5" font-family="Arial">1</text>
            <text x="2" y="9" font-size="5" font-family="Arial">2</text>
            <text x="2" y="13" font-size="5" font-family="Arial">3</text>
            <path d="M6 3.5h8v1H6zM6 7.5h8v1H6zM6 11.5h8v1H6z"/>
          </svg>
        </button>
      </div>

      <div class="toolbar-divider"></div>

      <!-- Font Controls -->
      <div class="toolbar-group">
        <select 
          v-model="selectedFont" 
          @change="changeFont"
          class="font-selector"
        >
          <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif">System</option>
          <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
          <option value="'Times New Roman', Times, serif">Times</option>
          <option value="Georgia, serif">Georgia</option>
          <option value="'Courier New', Courier, monospace">Courier</option>
          <option value="'Monaco', 'Courier New', monospace">Monaco</option>
          <option value="'Arial', sans-serif">Arial</option>
          <option value="'Verdana', sans-serif">Verdana</option>
          <option value="'Comic Sans MS', cursive">Comic Sans</option>
        </select>

        <select 
          v-model="selectedSize" 
          @change="changeFontSize"
          class="size-selector"
        >
          <option value="1">8pt</option>
          <option value="2">10pt</option>
          <option value="3">12pt</option>
          <option value="4">14pt</option>
          <option value="5">18pt</option>
          <option value="6">24pt</option>
          <option value="7">36pt</option>
        </select>
      </div>

      <div class="toolbar-divider"></div>

      <!-- Additional Actions -->
      <div class="toolbar-group">
        <button 
          @click="handleClearFormatting" 
          title="Clear Formatting"
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8.5 2L3 7.5 4.5 9l2-2v7h2V7l2 2L12 7.5 8.5 2zM2 14h12v1H2z"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Rich Text Editor -->
    <div 
      ref="editor"
      class="editor"
      contenteditable="true"
      @input="onInput"
      @keydown="handleKeyDown"
      @paste="handlePasteEvent"
      spellcheck="true"
      data-placeholder="Start typing..."
      :style="{ zoom: `${currentZoom}%` }"
    >
    </div>

    <!-- Save Modal -->
    <div v-if="showSaveModal" class="modal-overlay" @click.self="closeSaveModal">
      <div class="modal">
        <div class="modal-header">
          <h3>Save File</h3>
          <button class="modal-close" @click="closeSaveModal">Ã—</button>
        </div>
        <div class="modal-body">
          <label for="filename">Save as:</label>
          <div class="filename-input-wrapper">
            <input 
              id="filename"
              v-model="saveFilename"
              type="text"
              placeholder="Untitled"
              @keyup.enter="saveDocument"
              @keyup.escape="closeSaveModal"
              ref="saveInput"
            />
            <span class="filename-extension">.md</span>
          </div>
        </div>
        <div class="modal-footer">
          <button class="modal-button cancel" @click="closeSaveModal">Cancel</button>
          <button class="modal-button save" @click="saveDocument">Save</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted, reactive, watch, nextTick } from 'vue'
import { useOSStore } from '../../../../stores/os'
import { register } from '../../../composables/menuCommands'

defineOptions({ name: 'TextEditApp' })

const editor = ref<HTMLElement>()
const selectedFont = ref("-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif")
const selectedSize = ref("3")
const showToolbar = ref(true)
const currentZoom = ref(100)

// Reactive state for tracking active formats
const activeFormats = reactive({
  bold: false,
  italic: false,
  underline: false,
  strikeThrough: false,
  justifyLeft: false,
  justifyCenter: false,
  justifyRight: false,
  justifyFull: false,
  insertUnorderedList: false,
  insertOrderedList: false
})

const documentTitle = ref('Untitled')
const showSaveModal = ref(false)
const saveFilename = ref('')
const saveInput = ref<HTMLInputElement>()

// Get current window ID from props or context
const props = defineProps<{
  windowId?: number
}>()

const osStore = useOSStore()

// Update window title when document title changes
watch(documentTitle, (newTitle) => {
  if (props.windowId) {
    const window = osStore.windows.find(w => w.id === props.windowId)
    if (window) {
      window.title = newTitle
    }
  }
})

// Command handlers for menu items
const handleBold = () => format('bold')
const handleItalic = () => format('italic')
const handleUnderline = () => format('underline')
const handleStrikethrough = () => format('strikeThrough')

const handleAlignLeft = () => format('justifyLeft')
const handleAlignCenter = () => format('justifyCenter')
const handleAlignRight = () => format('justifyRight')
const handleJustify = () => format('justifyFull')

const handleBulletList = () => format('insertUnorderedList')
const handleNumberedList = () => format('insertOrderedList')

const handleIncreaseIndent = () => format('indent')
const handleDecreaseIndent = () => format('outdent')

const handleClearFormatting = () => format('removeFormat')

const handleUndo = () => {
  document.execCommand('undo')
  editor.value?.focus()
}

const handleRedo = () => {
  document.execCommand('redo')
  editor.value?.focus()
}

const handleCut = () => {
  document.execCommand('cut')
  editor.value?.focus()
}

const handleCopy = () => {
  document.execCommand('copy')
  editor.value?.focus()
}

const handlePaste = () => {
  document.execCommand('paste')
  editor.value?.focus()
}

const handlePasteAndMatchStyle = () => {
  // Get plain text from clipboard
  navigator.clipboard.readText().then(text => {
    document.execCommand('insertText', false, text)
    editor.value?.focus()
  })
}

const handleSelectAll = () => {
  document.execCommand('selectAll')
  editor.value?.focus()
}

const handleFontSizeSmaller = () => {
  const currentSizeIndex = parseInt(selectedSize.value)
  if (currentSizeIndex > 1) {
    selectedSize.value = String(currentSizeIndex - 1)
    changeFontSize()
  }
}

const handleFontSizeLarger = () => {
  const currentSizeIndex = parseInt(selectedSize.value)
  if (currentSizeIndex < 7) {
    selectedSize.value = String(currentSizeIndex + 1)
    changeFontSize()
  }
}

const handleZoomIn = () => {
  if (currentZoom.value < 200) {
    currentZoom.value += 10
    if (editor.value) {
      editor.value.style.zoom = `${currentZoom.value}%`
    }
  }
}

const handleZoomOut = () => {
  if (currentZoom.value > 50) {
    currentZoom.value -= 10
    if (editor.value) {
      editor.value.style.zoom = `${currentZoom.value}%`
    }
  }
}

const handleZoomReset = () => {
  currentZoom.value = 100
  if (editor.value) {
    editor.value.style.zoom = '100%'
  }
}

const handleToggleToolbar = () => {
  showToolbar.value = !showToolbar.value
}

const handlePrint = () => {
  window.print()
}

const handleOpen = () => {
  // Open functionality would go here
  // For now, just show a message
  console.log('Open file feature not yet implemented')
}

const format = (command: string, value?: string) => {
  document.execCommand(command, false, value)
  editor.value?.focus()
  // Update active states after formatting
  updateActiveFormats()
}

const isFormatActive = (command: string) => {
  return activeFormats[command as keyof typeof activeFormats] || false
}

const updateActiveFormats = () => {
  // Update text formatting states
  activeFormats.bold = document.queryCommandState('bold')
  activeFormats.italic = document.queryCommandState('italic')
  activeFormats.underline = document.queryCommandState('underline')
  activeFormats.strikeThrough = document.queryCommandState('strikeThrough')
  
  // Update alignment states
  activeFormats.justifyLeft = document.queryCommandState('justifyLeft')
  activeFormats.justifyCenter = document.queryCommandState('justifyCenter')
  activeFormats.justifyRight = document.queryCommandState('justifyRight')
  activeFormats.justifyFull = document.queryCommandState('justifyFull')
  
  // Update list states
  activeFormats.insertUnorderedList = document.queryCommandState('insertUnorderedList')
  activeFormats.insertOrderedList = document.queryCommandState('insertOrderedList')
  
  // Update font selectors with current values
  const fontName = document.queryCommandValue('fontName')
  if (fontName) {
    // Remove quotes from font name for comparison
    const cleanFontName = fontName.replace(/['"]/g, '')
    const matchingOption = Array.from(document.querySelectorAll('.font-selector option')).find(
      option => option.getAttribute('value')?.includes(cleanFontName)
    )
    if (matchingOption) {
      selectedFont.value = matchingOption.getAttribute('value') || selectedFont.value
    }
  }
  
  const fontSize = document.queryCommandValue('fontSize')
  if (fontSize) {
    selectedSize.value = fontSize
  }
}

const changeFont = () => {
  format('fontName', selectedFont.value)
}

const changeFontSize = () => {
  format('fontSize', selectedSize.value)
}

const onInput = () => {
  // Update active formats on input
  updateActiveFormats()
}

const handleKeyDown = (e: KeyboardEvent) => {
  // Add keyboard shortcuts
  if (e.metaKey || e.ctrlKey) {
    switch(e.key) {
      case 'b':
        e.preventDefault()
        format('bold')
        break
      case 'i':
        e.preventDefault()
        format('italic')
        break
      case 'u':
        e.preventDefault()
        format('underline')
        break
    }
  }
}

const handlePasteEvent = (e: ClipboardEvent) => {
  // Handle paste event to maintain formatting
  e.preventDefault()
  const text = e.clipboardData?.getData('text/html') || e.clipboardData?.getData('text/plain')
  if (text) {
    document.execCommand('insertHTML', false, text)
  }
}

// Handle selection changes
const handleSelectionChange = () => {
  updateActiveFormats()
}

const handleSaveCommand = () => {
  openSaveModal()
}

const handleSaveAs = () => {
  openSaveModal()
}

const openSaveModal = () => {
  showSaveModal.value = true
  saveFilename.value = documentTitle.value === 'Untitled' ? '' : documentTitle.value
  nextTick(() => {
    saveInput.value?.focus()
    saveInput.value?.select()
  })
}

const closeSaveModal = () => {
  showSaveModal.value = false
  saveFilename.value = ''
}

const saveDocument = () => {
  const filename = saveFilename.value.trim() || 'Untitled'
  const fullFilename = filename.endsWith('.md') ? filename : `${filename}.md`
  
  // Remove extension for title display
  const titleWithoutExt = fullFilename.replace(/\.(md|txt|rtf|html)$/i, '')
  documentTitle.value = titleWithoutExt
  
  // Here you could implement actual save logic when filesystem is available
  // For now, we just update the title
  console.log('Would save file:', fullFilename)
  
  closeSaveModal()
}

onMounted(() => {
  // Register all command handlers
  register('textedit.save', handleSaveCommand)
  register('textedit.saveAs', handleSaveAs)
  register('textedit.open', handleOpen)
  register('textedit.print', handlePrint)
  
  // Edit commands  
  register('textedit.undo', handleUndo)
  register('textedit.redo', handleRedo)
  register('textedit.cut', handleCut)
  register('textedit.copy', handleCopy)
  register('textedit.paste', handlePaste)
  register('textedit.pasteAndMatchStyle', handlePasteAndMatchStyle)
  register('textedit.selectAll', handleSelectAll)
  
  // Format commands
  register('textedit.bold', handleBold)
  register('textedit.italic', handleItalic)
  register('textedit.underline', handleUnderline)
  register('textedit.strikethrough', handleStrikethrough)
  register('textedit.alignLeft', handleAlignLeft)
  register('textedit.alignCenter', handleAlignCenter)
  register('textedit.alignRight', handleAlignRight)
  register('textedit.justify', handleJustify)
  register('textedit.bulletList', handleBulletList)
  register('textedit.numberedList', handleNumberedList)
  register('textedit.increaseIndent', handleIncreaseIndent)
  register('textedit.decreaseIndent', handleDecreaseIndent)
  register('textedit.clearFormatting', handleClearFormatting)
  register('textedit.fontSizeSmaller', handleFontSizeSmaller)
  register('textedit.fontSizeLarger', handleFontSizeLarger)
  
  // View commands
  register('textedit.zoomIn', handleZoomIn)
  register('textedit.zoomOut', handleZoomOut)
  register('textedit.zoomReset', handleZoomReset)
  register('textedit.toggleToolbar', handleToggleToolbar)
  
  // Add selection change listener to update toolbar states
  document.addEventListener('selectionchange', handleSelectionChange)
  
  // Add click listener to editor to update states
  editor.value?.addEventListener('click', updateActiveFormats)
  editor.value?.addEventListener('keyup', updateActiveFormats)
  
  // Set initial alignment state
  updateActiveFormats()
})

onUnmounted(() => {
  // Clean up event listeners
  document.removeEventListener('selectionchange', handleSelectionChange)
})
</script>

<style scoped>
.textedit-app {
  height: 100%;
  display: flex;
  flex-direction: column;
  background: white;
  position: relative; /* Make this the containing block for absolute positioned modal */
}

.toolbar {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  background: linear-gradient(to bottom, #f6f6f6, #e8e8e8);
  border-bottom: 1px solid #d1d1d1;
  gap: 8px;
  flex-wrap: wrap;
}

.toolbar-group {
  display: flex;
  gap: 4px;
  align-items: center;
}

.toolbar-divider {
  width: 1px;
  height: 24px;
  background: #c8c8c8;
}

.toolbar button {
  width: 32px;
  height: 28px;
  border: 1px solid transparent;
  background: transparent;
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: #333;
  transition: all 0.2s;
}

.toolbar button:hover {
  background: rgba(0, 0, 0, 0.05);
  border-color: rgba(0, 0, 0, 0.1);
}

.toolbar button:active {
  background: rgba(0, 0, 0, 0.1);
}

.toolbar button.active {
  background: rgba(0, 122, 255, 0.15);
  border-color: rgba(0, 122, 255, 0.3);
  color: #007AFF;
}

.font-selector,
.size-selector {
  padding: 4px 8px;
  border: 1px solid #c8c8c8;
  border-radius: 4px;
  background: white;
  font-size: 12px;
  color: #333;
  cursor: pointer;
  outline: none;
}

.font-selector:hover,
.size-selector:hover {
  border-color: #999;
}

.font-selector:focus,
.size-selector:focus {
  border-color: #007AFF;
  box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}

.font-selector {
  min-width: 120px;
}

.size-selector {
  min-width: 60px;
}

.editor {
  flex: 1;
  padding: 20px;
  outline: none;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  background: white;
  overflow-y: auto;
  word-wrap: break-word;
  position: relative;
}

.editor:focus {
  outline: none;
}

.editor p {
  margin: 0 0 1em 0;
}

.editor p:last-child {
  margin-bottom: 0;
}

.editor ul,
.editor ol {
  margin: 0 0 1em 0;
  padding-left: 2em;
}

.editor li {
  margin-bottom: 0.25em;
}

.editor blockquote {
  margin: 0 0 1em 0;
  padding-left: 1em;
  border-left: 3px solid #ddd;
  color: #666;
}

/* Placeholder styling */
.editor:empty:before {
  content: attr(data-placeholder);
  color: #999;
  pointer-events: none;
  position: absolute;
}

/* Print styles */
@media print {
  .toolbar {
    display: none;
  }
  
  .editor {
    border: none;
    padding: 0;
  }
}

/* Modal Styles */
.modal-overlay {
  position: absolute; /* Changed from fixed to absolute */
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000; /* Reduced from 10000 since it's now within the window */
}

.modal {
  background: white;
  border-radius: 8px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  width: 400px;
  max-width: 90%; /* Changed from 90vw to 90% to be relative to container */
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e5e5;
}

.modal-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-close:hover {
  color: #333;
}

.modal-body {
  padding: 20px;
}

.modal-body label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  color: #333;
}

.modal-body input {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #d1d1d1;
  border-radius: 4px;
  font-size: 14px;
  outline: none;
}

.modal-body input:focus {
  border-color: #007AFF;
  box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
}

.filename-input-wrapper {
  display: flex;
  align-items: center;
  border: 1px solid #d1d1d1;
  border-radius: 4px;
  padding: 8px 12px;
  background: white;
}

.filename-input-wrapper input {
  border: none;
  padding: 0;
  margin: 0;
  width: 100%;
  font-size: 14px;
}

.filename-input-wrapper input:focus {
  outline: none;
}

.filename-extension {
  margin-left: 8px;
  font-size: 14px;
  color: #666;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 16px 20px;
  border-top: 1px solid #e5e5e5;
}

.modal-button {
  padding: 6px 16px;
  border-radius: 4px;
  font-size: 14px;
  cursor: pointer;
  border: 1px solid #d1d1d1;
  background: white;
  color: #333;
}

.modal-button:hover {
  background: #f5f5f5;
}

.modal-button.save {
  background: #007AFF;
  color: white;
  border-color: #007AFF;
}

.modal-button.save:hover {
  background: #0051D5;
}

.modal-button.cancel {
  background: #f5f5f5;
}
</style>
